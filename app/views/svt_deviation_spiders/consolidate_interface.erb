
<SCRIPT language="Javascript">
google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(drawChart);
google.setOnLoadCallback(drawChartTwo);

function change_score(consolidation_temp_id, value)
{
	$.ajax({
		type: "POST",
		url: "/svt_deviation_spiders/update_score",
 		data: {deviation_spider_consolidation_temp_id: consolidation_temp_id, deviation_spider_consolidation_temp_score: value}
	})
	.done(function( msg ) {
		var conso_id = "#" + consolidation_temp_id
		$(conso_id).val('');
	})
	.fail(function() 
	{ 
		alert("Error");
	})
}

function drawChart() {

	var maturity = <%= @maturity %>
	var rest = 100 - maturity

	var data = google.visualization.arrayToDataTable([
	  ['Maturity', 'Percent'],
	  ['Projects/Suite activities maturity reached for the current phase', maturity],
	  ['Delta', rest]
	]);

	var options = {
	  title: 'Activities maturity reached for the current phase',
	  pieHole: 0.5,
	  'width':450,
	  'height':350,
	  slices: {
	    0: { color: '#82FA58' },
	    1: { color: 'orange' }
	  },
	  pieSliceTextStyle: {
            color: 'black',
          }
	};

	var chart = new google.visualization.PieChart(document.getElementById('piechart'));

	google.visualization.events.addListener(chart, 'ready', function () {
	    piechart.innerHTML = '<img src="' + chart.getImageURI() + '">';
	    console.log(piechart.innerHTML);
	  });


	chart.draw(data, options);
}

function drawChartTwo() {

	var maturities = <%= @maturities.to_json %>;
	var maturities_name = <%= @maturities_name.to_json %>;
	var maturitieslength = maturities.length;

	if (maturitieslength > 0)Â {
		var data_temp = [];
		var Header = ['Percentage', 'Milestone', { role: 'style' }];
	 	data_temp.push(Header);

	 	for (var i=0; i < maturitieslength; i++) {
	 		data_temp.push([maturities_name[i], maturities[i], "#82FA58"]);
	 	}

		var data = google.visualization.arrayToDataTable(data_temp);

		var view = new google.visualization.DataView(data);
		view.setColumns([0, 1,
		                   { calc: "stringify",
		                     sourceColumn: 1,
		                     type: "string",
		                     role: "annotation" },
		                   2]);

		var options = {
		    title: "Reminders on previous phases activities maturity status (by %)",
		    width: 600,
		    height: 80,
		    bar: {groupWidth: "25%"},
		    legend: { position: "none" },
		    vAxis: { minValue: '0', maxValue: '100'}
		  };

		var chart = new google.visualization.ColumnChart(document.getElementById("histochart"));

		google.visualization.events.addListener(chart, 'ready', function () {
		    histochart.innerHTML = '<img src="' + chart.getImageURI() + '">';
		    console.log(histochart.innerHTML);
		  });

		chart.draw(view, options);
	}
}

//Open
$( document ).ready(function() {
	$(".conso_tf").focusout(function() {
		$.ajax({
			type: "POST",
			url: "/svt_deviation_spiders/update_justification",
	 		data: {deviation_spider_consolidation_temp_id: $(this).attr('id'), deviation_spider_consolidation_temp_justification: $(this).val()}
		})
		.done(function( msg ) {
		})
		.fail(function() 
		{ 
			alert("Error");
		})
	});
});


</SCRIPT>

<h2>Planned vs achieved deliverables</h2>
<table class="consolidation_table">

<tr class="consolidation_tr_activity">
	<td><table width=210><tr><td></td></tr></table></td>
	<td class="consolidation_td_activity"><bold>Deliverable</bold></td>
	<td class="consolidation_td_activity"><bold>Planned</bold></td>
	<td class="consolidation_td_activity"><bold>Achieved</bold></td>
	<td class="consolidation_td_activity"><bold>Comments</bold></td>
</tr>
<% @maturity_deliverables.each do |maturity| %>
<tr class="consolidation_tr_deliverable">
	<td class="consolidation_td_deliverable">
		<%= maturity.deliverable.name %>
	</td>
	<td class="consolidation_td_deliverable_left">
		<%= select_tag('achieved', options_for_select(@achieved_list, maturity.achieved), {:onchange=>"change_score(#{deliverable.id.to_s}, this.value);"}) %>
	</td>
	<td class="consolidation_td_deliverable_left">
		<%= select_tag('achieved', options_for_select(@achieved_list, maturity.achieved), {:onchange=>"change_score(#{deliverable.id.to_s}, this.value);"}) %>
	</td>
	<td class="consolidation_td_deliverable_right">
		<%= text_area_tag('comment', maturity.comment, :cols=>21, :rows=>1, :id=>"#{deliverable.id.to_s}", :class=>"conso_tf") %>
	</td>
</tr>
<% end %>
</table>

<br/><br/>

<h2>Export Deviation <span style="font-weight:normal; font-size:13px">- To be added to Quality Slide</span></h2>
<table>
	<tr><td style="border:1px outset black;">
		<div id="piechart" style="width: 450px; height: 350px;"></div>
		</td>
		<td align=center style="border:1px outset black;">
			<div id="histochart" style="width: 600px; height: 80px;">
				<% if @maturities.count == 0 %>
					<h3>Reminders on previous phases activities maturity status</h3>
					None of your previous milestones has been consolidated.
				<% end %>
			</div></td>
	</tr>
</table>

<br/>

<h2>Consolidation process</h2>
<% if @editable %>
<%= button_to "Consolidate", {:action => "consolidate_validation", :deviation_spider_id => @deviation_spider.id} %>
<% end %>